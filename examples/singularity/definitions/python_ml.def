Bootstrap: library
From: ubuntu:22.04

%labels
    Author idmtools
    Version 1.0
    Description Python machine learning and deep learning environment

%help
    This container provides Python 3.11 with machine learning libraries:
    - TensorFlow, Keras (deep learning)
    - PyTorch (deep learning)
    - Scikit-learn (traditional ML)
    - XGBoost, LightGBM (gradient boosting)
    - Optuna (hyperparameter optimization)

    Usage:
        singularity exec python_ml.sif python3 train_model.py
        singularity exec python_ml.sif python3 -c "import torch; print(torch.__version__)"

    Note: This is CPU-only. For GPU support, use --nv flag and appropriate base image.

%post
    # Update system
    apt-get update && apt-get install -y \
        python3.11 \
        python3-pip \
        python3-dev \
        build-essential \
        wget \
        ca-certificates

    # Upgrade pip
    python3 -m pip install --upgrade pip setuptools wheel

    # Install ML packages
    pip3 install --no-cache-dir \
        numpy>=1.24.0 \
        pandas>=2.0.0 \
        matplotlib>=3.7.0 \
        seaborn>=0.12.0 \
        scikit-learn>=1.3.0 \
        xgboost>=2.0.0 \
        lightgbm>=4.0.0 \
        optuna>=3.3.0 \
        joblib>=1.3.0 \
        tqdm>=4.66.0

    # Install deep learning frameworks (CPU versions)
    pip3 install --no-cache-dir \
        tensorflow-cpu>=2.13.0 \
        keras>=2.13.0 \
        torch>=2.0.0 --index-url https://download.pytorch.org/whl/cpu \
        torchvision>=0.15.0 --index-url https://download.pytorch.org/whl/cpu

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    pip3 cache purge

%environment
    export PYTHONUNBUFFERED=1
    export TF_CPP_MIN_LOG_LEVEL=2
    export MPLBACKEND=Agg

%runscript
    exec python3 "$@"
